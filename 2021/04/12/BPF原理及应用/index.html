<!DOCTYPE html>
<html lang="en">
  <head><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="BPF原理及应用"/><link rel="alternate" href="/atom.xml" title="Stone's Blog" type="application/atom+xml"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.2" />
<link rel="canonical" href="http://example.com/2021/04/12/BPF原理及应用/"/>

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.2" />

<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null,"server_url":null,"cdn":null},"toc":true,"fancybox":true,"pjax":"","latex":false};
</script>

    <title>BPF原理及应用 - Stone's Blog</title>
  <meta name="generator" content="Hexo 5.2.0"></head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Stone's Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">Home
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Stone's Blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            Home
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">BPF原理及应用
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2021-04-12
        </span></div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Kernel-tracing"><span class="toc-text">1. Kernel tracing</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-0-%E4%BB%8B%E7%BB%8D"><span class="toc-text">1.0 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E9%9D%99%E6%80%81-tracing"><span class="toc-text">1.1 静态 tracing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-ftrace"><span class="toc-text">1.2 ftrace</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-1-%E5%AE%9A%E4%B9%89"><span class="toc-text">1.2.1 定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-2-ftrace-plugins"><span class="toc-text">1.2.2 ftrace plugins</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-3-ftrace-events"><span class="toc-text">1.2.3 ftrace events</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-4-Plugins-and-events"><span class="toc-text">1.2.4 Plugins and events</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-5-ftrace-%E7%9A%84%E9%99%90%E5%88%B6"><span class="toc-text">1.2.5 ftrace 的限制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-6-trace-cmd"><span class="toc-text">1.2.6 trace-cmd</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E5%8A%A8%E6%80%81-tracing"><span class="toc-text">1.3 动态 tracing</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-1Definition"><span class="toc-text">1.3.1Definition</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-2-kprobe-jprobe-uprobe"><span class="toc-text">1.3.2 kprobe jprobe uprobe</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-3-3-biosnoop"><span class="toc-text">1.3.3 biosnoop</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-BPF-%E4%BC%98%E5%8A%BF"><span class="toc-text">3.1 BPF 优势</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-BPF-%E6%8C%87%E4%BB%A4%E9%9B%86"><span class="toc-text">3.2 BPF 指令集</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-3-BPF-Help-Functions"><span class="toc-text">3.3 BPF Help Functions</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-1-%E5%AE%9A%E4%B9%89"><span class="toc-text">3.3.1 定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-3-2-%E6%A0%B7%E4%BE%8B"><span class="toc-text">3.3.2  样例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-4-bpf-program-type"><span class="toc-text">3.4 bpf_program_type</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-5-BPF-Maps"><span class="toc-text">3.5 BPF Maps</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-1-Maps-types"><span class="toc-text">3.5.1 Maps types</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-2-BPF-MAP"><span class="toc-text">3.5.2 BPF MAP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5-3-Loader"><span class="toc-text">3.5.3 Loader</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-BCC"><span class="toc-text">4.BCC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%AE%89%E8%A3%85-bcc-%E7%8E%AF%E5%A2%83"><span class="toc-text">4.1 安装 bcc 环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-tools-vfsstat-py"><span class="toc-text">4.2 tools&#x2F;vfsstat.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-tools-biosnoop-py"><span class="toc-text">4.3 tools&#x2F;biosnoop.py</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E5%A6%82%E6%9E%9C%E6%B2%A1%E6%9C%89bcc%E5%91%A2"><span class="toc-text">4.4 如果没有bcc呢?</span></a></li></ol></li></ol>
    </div>
  </div><div class="post-content"><p>本文基本上是对 PingCAP wenbo zhang  <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1B4411S7PP">Infra Meetup  No.111</a> 的笔记，还有对<code>bcc</code>的一些学习整理。</p>
<a id="more"></a> 

<p>BPF原理及应用这是一个很大的话题。但是再大的话题也能分割成一个个小话题。这段时间一直在折腾BPF相关的东西，却有些像盲人摸象，摸到哪里算哪。故而写一篇文章来总结一下。</p>
<p>Ok, 3..2..1..Let’s do it.</p>
<hr>
<p>先从 <code>tracing</code> 这个场景开始讲。</p>
<h2 id="1-Kernel-tracing"><a href="#1-Kernel-tracing" class="headerlink" title="1. Kernel tracing"></a>1. Kernel tracing</h2><h3 id="1-0-介绍"><a href="#1-0-介绍" class="headerlink" title="1.0 介绍"></a>1.0 介绍</h3><ul>
<li>Static tracing -&gt; Tracepoint（event trace）</li>
<li>Dynamic tracing -&gt; kprobe</li>
</ul>
<p>kernel tracing主要分为Static  tracing 和动态 Dynamic tracing</p>
<p>Static  tracing:  相当于对程序里面自己去写一些trace log，随着代码的编译 ，编译到代码里边。</p>
<p>Dynamic tracing :程序在运行的过程当中。可以在不打断程序的运行，可以对它某一个指令进行追踪。</p>
<h3 id="1-1-静态-tracing"><a href="#1-1-静态-tracing" class="headerlink" title="1.1 静态 tracing"></a>1.1 静态 tracing</h3><p>​    看一个静态追踪的例子:</p>
<p><code>perf tools</code> 就是基于静态 trace 实现的。</p>
<p><img src="https://raw.githubusercontent.com/brendangregg/perf-tools/master/images/perf-tools_2016.png" alt="img"></p>
<p>看一下<code>perf tools</code>中的<code>execsnoop</code></p>
<p><code>execsnoop</code>: trace process exec() with command line argument details.</p>
<p><code>execsnoop</code>实现上是对linux调度器子系统的一些trace，以及对exec()这个系统调用的一些trace.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> --depth 1 https://github.com/brendangregg/perf-tools</span><br><span class="line">$ <span class="built_in">cd</span> perf-tools/</span><br><span class="line">$ ./execsnoop</span><br></pre></td></tr></table></figure>

<p>可以得到下面的结果。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">➜  perf-tools git:(master) ./execsnoop</span><br><span class="line">Tracing <span class="built_in">exec</span>()s. Ctrl-C to end.</span><br><span class="line">Instrumenting sys_execve</span><br><span class="line">   PID   PPID ARGS</span><br><span class="line">  3049      0 mawk -W interactive -v o=1 -v opt_name=0 -v name= [...]</span><br><span class="line">  3050      0 cat -v trace_pipe</span><br><span class="line">  3051      0 /bin/sh -c ls -l /proc/[0-9]*/fd/[0-9]* | grep socket:</span><br><span class="line">  3053      0 grep socket:</span><br><span class="line">  3052      0 ls -l /proc/1/fd/0 /proc/1/fd/1 /proc/1/fd/10 /proc/1/fd/11 /proc/1/fd/12 /proc/1/fd/13 /proc/1/fd/14 [...]</span><br><span class="line">  3054      0 /bin/sh -c ls -l /proc/[0-9]*/fd/[0-9]* | grep socket:</span><br><span class="line">  3056      0 grep socket:</span><br><span class="line">  3055      0 ls -l /proc/1/fd/0 /proc/1/fd/1 /proc/1/fd/10 /proc/1/fd/11 /proc/1/fd/12 /proc/1/fd/13 /proc/1/fd/14 [...]</span><br><span class="line">  3057      0 /bin/sh -c ls -l /proc/[0-9]*/fd/[0-9]* | grep socket:</span><br><span class="line">  3059      0 grep socket:</span><br><span class="line">  3058      0 ls -l /proc/1/fd/0 /proc/1/fd/1 /proc/1/fd/10 /proc/1/fd/11 /proc/1/fd/12 /proc/1/fd/13 /proc/1/fd/14 [...]</span><br><span class="line">^C</span><br><span class="line">Ending tracing...</span><br></pre></td></tr></table></figure>

<p>execsnoop的部分代码如下。可以看到和下面的 ftrace 例子有相似之处</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">### setup and begin tracing</span></span><br><span class="line"><span class="built_in">echo</span> nop &gt; current_tracer</span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">echo</span> <span class="variable">$kprobe</span> &gt;&gt; kprobe_events 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">	makeprobe stub_execve</span><br><span class="line">	<span class="keyword">if</span> ! <span class="built_in">echo</span> <span class="variable">$kprobe</span> &gt;&gt; kprobe_events 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">	    makeprobe do_execve</span><br><span class="line">	    <span class="keyword">if</span> ! <span class="built_in">echo</span> <span class="variable">$kprobe</span> &gt;&gt; kprobe_events 2&gt;/dev/null; <span class="keyword">then</span></span><br><span class="line">		    edie <span class="string">&quot;ERROR: adding a kprobe for execve. Exiting.&quot;</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">	<span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">echo</span> 1 &gt; events/kprobes/<span class="variable">$kname</span>/<span class="built_in">enable</span>; <span class="keyword">then</span></span><br><span class="line">	edie <span class="string">&quot;ERROR: enabling kprobe for execve. Exiting.&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">echo</span> 1 &gt; events/<span class="built_in">sched</span>/sched_process_fork/<span class="built_in">enable</span>; <span class="keyword">then</span></span><br><span class="line">	edie <span class="string">&quot;ERROR: enabling sched:sched_process_fork tracepoint. Exiting.&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>而perf-tools 具体是基于 <code>ftrace</code> 实现的脚本 ，顺着思路去了解 <code>ftrace</code>.  </p>
<h3 id="1-2-ftrace"><a href="#1-2-ftrace" class="headerlink" title="1.2 ftrace"></a>1.2 ftrace</h3><h4 id="1-2-1-定义"><a href="#1-2-1-定义" class="headerlink" title="1.2.1 定义"></a>1.2.1 定义</h4><p>Ftrace is an internal tracer designed to help out developers and designers of systems to fifind what is going on inside the kernel.</p>
<p>It can be used for debugging or analyzing latencies and performance issues that take place outside of user-space.</p>
<blockquote>
<p>大概就是一个 trace 工具…</p>
</blockquote>
<p>原来的<code>ftrace</code> 只是一个<code>funtion trace</code> ,</p>
<p>现在发展为一个框架，包含<code>plugins</code> <code>events</code>这两个方式。</p>
<hr>
<h4 id="1-2-2-ftrace-plugins"><a href="#1-2-2-ftrace-plugins" class="headerlink" title="1.2.2 ftrace plugins"></a>1.2.2 ftrace plugins</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.c</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span><br><span class="line">	<span class="keyword">char</span> buf[<span class="number">4096</span>];</span><br><span class="line">	sleep(<span class="number">30</span>);</span><br><span class="line">	<span class="keyword">int</span> fd = open(<span class="string">&quot;./test.c&quot;</span>,O_RDONLY);</span><br><span class="line">	read(fd,buf,<span class="number">4096</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># ftrace_test.sh</span></span><br><span class="line">debugfs=/sys/kernel/debug</span><br><span class="line"><span class="built_in">echo</span> nop &gt; <span class="variable">$debugfs</span>/tracing/current_tracer</span><br><span class="line"><span class="built_in">echo</span> 0 &gt; <span class="variable">$debugfs</span>/tracing/tracing_on</span><br><span class="line"><span class="built_in">echo</span> `pidof <span class="built_in">read</span>` &gt; <span class="variable">$debugfs</span>/tracing/set_ftrace_pid</span><br><span class="line"><span class="built_in">echo</span> function_graph &gt; <span class="variable">$debugfs</span>/tracing/current_tracer</span><br><span class="line"><span class="built_in">echo</span> vfs_read &gt; <span class="variable">$debugfs</span>/tracing/set_graph_function</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; <span class="variable">$debugfs</span>/tracing/tracing_on</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> gcc 1.c -o <span class="built_in">read</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./<span class="built_in">read</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同时在另一个终端</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> ./ftrace_test.sh</span></span><br></pre></td></tr></table></figure>

<p>然后<code>cat /sys/kernel/debug/tracing/trace</code>查看结果如下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># tracer: function_graph</span><br><span class="line">#</span><br><span class="line"># CPU  DURATION                  FUNCTION CALLS</span><br><span class="line"># |     |   |                     |   |   |   |</span><br><span class="line"> 0)               |  vfs_read() &#123;</span><br><span class="line"> 0)               |    rw_verify_area() &#123;</span><br><span class="line"> 0)               |      security_file_permission() &#123;</span><br><span class="line"> 0)               |        apparmor_file_permission() &#123;</span><br><span class="line"> 0)               |          common_file_perm() &#123;</span><br><span class="line"> 0)   0.327 us    |            aa_file_perm();</span><br><span class="line"> 0)   1.756 us    |          &#125;</span><br><span class="line"> 0)   2.787 us    |        &#125;</span><br><span class="line"> 0)               |        __fsnotify_parent() &#123;</span><br><span class="line"> 0)   0.327 us    |          dget_parent();</span><br><span class="line"> 0)               |          dput() &#123;</span><br><span class="line"> 0)               |            dput.part.26() &#123;</span><br><span class="line"> 0)               |              _cond_resched() &#123;</span><br><span class="line"> 0)   0.297 us    |                rcu_all_qs();</span><br><span class="line"> 0)   0.982 us    |              &#125;</span><br><span class="line"> 0)   1.724 us    |            &#125;</span><br><span class="line"> 0)   2.372 us    |          &#125;</span><br><span class="line"> 0)   3.800 us    |        &#125;</span><br><span class="line"> 0)   0.311 us    |        fsnotify();</span><br><span class="line"> 0)   8.335 us    |      &#125;</span><br><span class="line"> 0)   9.229 us    |    &#125;</span><br><span class="line"> 0)               |    __vfs_read() &#123;</span><br><span class="line"> 0)               |      new_sync_read() &#123;</span><br><span class="line"> 0)               |        ext4_file_read_iter() &#123;</span><br><span class="line"> 0)               |          generic_file_read_iter() &#123;</span><br><span class="line"> 0)               |            _cond_resched() &#123;</span><br><span class="line"> 0)   0.291 us    |              rcu_all_qs();</span><br><span class="line"> 0)   0.847 us    |            &#125;</span><br><span class="line"> 0)               |            pagecache_get_page() &#123;</span><br><span class="line"> 0)   0.593 us    |              find_get_entry();</span><br><span class="line"> 0)   1.227 us    |            &#125;</span><br><span class="line"> 0)   0.468 us    |            mark_page_accessed();</span><br><span class="line"> 0)               |            _cond_resched() &#123;</span><br><span class="line"> 0)   0.275 us    |              rcu_all_qs();</span><br><span class="line"> 0)   0.823 us    |            &#125;</span><br><span class="line"> 0)               |            _cond_resched() &#123;</span><br><span class="line"> 0)   0.235 us    |              rcu_all_qs();</span><br><span class="line"> 0)   1.009 us    |            &#125;</span><br><span class="line"> 0)               |            pagecache_get_page() &#123;</span><br><span class="line"> 0)   0.192 us    |              find_get_entry();</span><br><span class="line"> 0)   0.622 us    |            &#125;</span><br><span class="line"> 0)               |            touch_atime() &#123;</span><br><span class="line"> 0)               |              __atime_needs_update() &#123;</span><br><span class="line"> 0)               |                current_time() &#123;</span><br><span class="line"> 0)   0.300 us    |                  current_kernel_time64();</span><br><span class="line"> 0)   0.184 us    |                  timespec_trunc();</span><br><span class="line"> 0)   1.126 us    |                &#125;</span><br><span class="line"> 0)   1.709 us    |              &#125;</span><br><span class="line"> 0)   2.163 us    |            &#125;</span><br><span class="line"> 0) + 11.661 us   |          &#125;</span><br><span class="line"> 0) + 12.257 us   |        &#125;</span><br><span class="line"> 0) + 13.031 us   |      &#125;</span><br><span class="line"> 0) + 13.630 us   |    &#125;</span><br><span class="line"> 0)               |    __fsnotify_parent() &#123;</span><br><span class="line"> 0)   0.180 us    |      dget_parent();</span><br><span class="line"> 0)               |      dput() &#123;</span><br><span class="line"> 0)               |        dput.part.26() &#123;</span><br><span class="line"> 0)               |          _cond_resched() &#123;</span><br><span class="line"> 0)   0.178 us    |            rcu_all_qs();</span><br><span class="line"> 0)   0.529 us    |          &#125;</span><br><span class="line"> 0)   0.882 us    |        &#125;</span><br><span class="line"> 0)   1.228 us    |      &#125;</span><br><span class="line"> 0)   1.953 us    |    &#125;</span><br><span class="line"> 0)   0.182 us    |    fsnotify();</span><br><span class="line"> 0) + 29.688 us   |  &#125;</span><br></pre></td></tr></table></figure>

<p>这样就可以查看刚才这个C代码中<code>vfs_read</code>的相关调用流程。</p>
<hr>
<h4 id="1-2-3-ftrace-events"><a href="#1-2-3-ftrace-events" class="headerlink" title="1.2.3 ftrace events"></a>1.2.3 ftrace events</h4><p>在<code>/sys/kernel/debug/tracing/events</code>目录下可以看到可以<code>trace</code>的事件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">➜  events ls</span><br><span class="line">alarmtimer  filemap       mce             ras           thermal</span><br><span class="line">block       fs            mdio            raw_syscalls  thermal_power_allocator</span><br><span class="line">bpf         fs_dax        migrate         rcu           timer</span><br><span class="line">bridge      ftrace        mmc             regmap        tlb</span><br><span class="line">btrfs       gpio          module          regulator     udp</span><br><span class="line">cgroup      header_event  mpx             rpm           vmscan</span><br><span class="line">clk         header_page   msr             <span class="built_in">sched</span>         vsyscall</span><br><span class="line">cma         huge_memory   napi            scsi          wbt</span><br><span class="line">compaction  hyperv        net             signal        workqueue</span><br><span class="line">cpuhp       i2c           nmi             skb           writeback</span><br><span class="line">dma_fence   iommu         oom             smbus         x86_fpu</span><br><span class="line">drm         irq           page_isolation  sock          xdp</span><br><span class="line"><span class="built_in">enable</span>      irq_matrix    pagemap         spi           xen</span><br><span class="line">exceptions  irq_vectors   percpu          swiotlb       xfs</span><br><span class="line">ext4        jbd2          power           sync_trace    xhci-hcd</span><br><span class="line">fib         kmem          printk          syscalls</span><br><span class="line">fib6        kprobes       qdisc           task</span><br><span class="line">filelock    libata        random          tcp</span><br></pre></td></tr></table></figure>

<p>events的样例 可以看PingCAP 的<a target="_blank" rel="noopener" href="https://github.com/pingcap/tidb-inspect-tools/blob/master/tracing_tools/ftrace/mem/drsnoop">Drsnoop</a></p>
<hr>
<h4 id="1-2-4-Plugins-and-events"><a href="#1-2-4-Plugins-and-events" class="headerlink" title="1.2.4 Plugins and events"></a>1.2.4 Plugins and events</h4><p>plugins</p>
<p>● list in avaliable_tracers</p>
<p>● set via current_tracer</p>
<p>● only one at a time</p>
<blockquote>
<p>avaliable_tracers 目前我们只关注funtion 和 funciton_graph</p>
</blockquote>
<p>events</p>
<p>● list in avaliable_events</p>
<p>● set via set_event</p>
<p>● any number of events can be enable</p>
<hr>
<h4 id="1-2-5-ftrace-的限制"><a href="#1-2-5-ftrace-的限制" class="headerlink" title="1.2.5 ftrace 的限制"></a>1.2.5 ftrace 的限制</h4><p>● Default, all events share a global ring buffer</p>
<p>● trace_pipe is globally shared, so concurrent</p>
<p>programs will have clashing output</p>
<p>● Not programmable</p>
<p>● Predefifined</p>
<p>● Max fifilter expression’s size &lt; 4096( one  page)</p>
<blockquote>
<p>我觉得最关键的是不可编程。这也就是BPF 存在的意义之一。</p>
</blockquote>
<hr>
<h4 id="1-2-6-trace-cmd"><a href="#1-2-6-trace-cmd" class="headerlink" title="1.2.6 trace-cmd"></a>1.2.6 trace-cmd</h4><p>对 ftrace 进行了一层封装的CLI工具，也称为trace 的frontend，简单好用。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt-get install -y trace-cmd</span><br><span class="line">$ sudo trace-cmd record -p function_graph -P 12089 -e     </span><br><span class="line">$ sudo trace-cmd report </span><br></pre></td></tr></table></figure>

<blockquote>
<p>大家可以执行一下。</p>
</blockquote>
<hr>
<h3 id="1-3-动态-tracing"><a href="#1-3-动态-tracing" class="headerlink" title="1.3 动态 tracing"></a>1.3 动态 tracing</h3><p><strong>kprobe</strong></p>
<h4 id="1-3-1Definition"><a href="#1-3-1Definition" class="headerlink" title="1.3.1Definition"></a>1.3.1Definition</h4><p>Kprobe enables you to dynamically break into any kernel routine and collect debugging and performance information non-disruptively. You can trap at almost any kernel code address, specifying a  handler routine to be invoked when the breakpoint is hit.</p>
<blockquote>
<p>kprobe 几乎可以对内核中每一条指令进行打断。实际上是做的一个指令(代码)替换，执行到某一条被替换的指令会触发异常。内核会判断是gdb引发的异常还是kprobe引发的异常。如果是kprobe引发的异常，会把正常的指令替换回来，然后去调用已注册的回调函数。</p>
</blockquote>
<p>有些和kprobe相关的函数不能trace, 定义在<code>/sys/kernel/debug/kprobes/blacklist</code></p>
<hr>
<h4 id="1-3-2-kprobe-jprobe-uprobe"><a href="#1-3-2-kprobe-jprobe-uprobe" class="headerlink" title="1.3.2 kprobe jprobe uprobe"></a>1.3.2 kprobe jprobe uprobe</h4><p>● A kprobe can be inserted on virtually any instruction in the kernel. </p>
<p>● A jprobe is inserted at the entry to a kernel function, and provides convenient access to the function’s arguments. </p>
<p>● A return probe fifires when a specifified function returns.</p>
<blockquote>
<p>rprobe 和jprobe 是基于kprobe的封装，简化了一些工作。</p>
<p>jprobe 只能放在函数的开始  </p>
<p>rprobe 只能放在函数的返回阶段</p>
<p>但是我目前在bcc 中是直接使用kprobe 和kretprobe .估计做了一层封装</p>
</blockquote>
<h4 id="1-3-3-biosnoop"><a href="#1-3-3-biosnoop" class="headerlink" title="1.3.3 biosnoop"></a>1.3.3 biosnoop</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blk_account_io_start</span><span class="params">(struct request *rq, <span class="keyword">bool</span> new_io)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blk_start_request</span><span class="params">(struct request *req)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blk_mq_start_request</span><span class="params">(struct request *rq)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">blk_account_io_done</span><span class="params">(struct request *req)</span> </span></span><br><span class="line"><span class="function">  </span></span><br></pre></td></tr></table></figure>

<blockquote>
<p> 前三个函数是IO开始<br>第四个函数则是IO结束<br>blk_account_io_start包含在IO等待队列的时间<br>blk_start_request 是老的block设备<br>blk_mq_start_request 新的SSD设备 支持多队列的设备</p>
</blockquote>
<p><code>blktrace</code></p>
<hr>
<p>perf_events</p>
<p><img src="http://www.brendangregg.com/perf_events/perf_events_map.png" alt="img"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">比ftrace events 多了CPU相关</span><br></pre></td></tr></table></figure>

<p>front-end</p>
<p><code>perf</code> </p>
<hr>
<p>所以一个问题。已经有了这些这么好的工具。为什么还需要BPF？</p>
<blockquote>
<p>BPF整合了kprobe 和 tracepoint 从我的视角来说。或者说一个上层的使用者来说。</p>
</blockquote>
<hr>
<p><strong>BPF characteristic</strong></p>
<p>● User-defifined callback functions and data  processing can run directly in kernel space</p>
<p>● The user’s callback function impl is dyn executed, doesn’t participate in the compilation of the kernel, just like scripts</p>
<p>● Provide a unifified tracing framework for users</p>
<p>● BPF programs never crash kernel</p>
<p>● In addition, can do high-performance network processing or sandbox</p>
<blockquote>
<p>1.解决了数据拷贝问题。</p>
<p>2.用户态的回调函数是动态执行的，不需要参与内核的编译。</p>
<p>3.提高了一个统一的框架，可以用kprobe,可以用ftrace 。通过调用不同的helper函数就可以和不同的子系统打交道。</p>
<p>4.不会导致内核挂掉。</p>
</blockquote>
<hr>
<p>BPF tools</p>
<p><img src="https://github.com/iovisor/bcc/raw/master/images/bcc_tracing_tools_2019.png" alt="img"></p>
<blockquote>
<p>对比 perf_tools 和perf_events 丰富了很多。</p>
</blockquote>
<hr>
<h3 id="3-1-BPF-优势"><a href="#3-1-BPF-优势" class="headerlink" title="3.1 BPF 优势"></a>3.1 BPF 优势</h3><p>● Making the kernel programmable without having to cross kernel/user space boundaries</p>
<p>● Given the flflexibility of a programmable data path</p>
<p>● BPF programs can be updated without restart kernel</p>
<p>● BPF provides a stable API to user space</p>
<p>● Kernel guarantees safety, BPF programs never crash kernel </p>
<hr>
<h3 id="3-2-BPF-指令集"><a href="#3-2-BPF-指令集" class="headerlink" title="3.2 BPF 指令集"></a>3.2 BPF 指令集</h3><p>● <strong>Eleven 64 bit registers (r0~r10) with</strong> 32 bit sub registers (zero-exntend)</p>
<p>​    ○ r10 (ro, fp)</p>
<p>​    ○ r0 (ret val)</p>
<p>​    ○ r1 - r5 (args to helper func)</p>
<p>​    ○ r1 (ctx defifined by prog_type) </p>
<p>​    ○ r6 - r9 (callee saved regs on helper func call) </p>
<p>● One PC register</p>
<p>● 512B BPF stack space</p>
<p>Map one to one to HW CPU </p>
<p>regs, when jit enabled</p>
<p><strong>Limit</strong></p>
<p>● BPF_CALL0 ~ BPF_CALL5</p>
<p>● Max 4096 insts per prog</p>
<p>● Verififier fobids loops (kernel 5.3 will </p>
<p>support bounded loops)</p>
<p>● Max 32 tail calls</p>
<blockquote>
<p>依旧是不太了解，但只是一个概念。</p>
</blockquote>
<hr>
<h2 id="3-3-BPF-Help-Functions"><a href="#3-3-BPF-Help-Functions" class="headerlink" title="3.3 BPF Help Functions"></a>3.3 <strong>BPF Help Functions</strong></h2><h4 id="3-3-1-定义"><a href="#3-3-1-定义" class="headerlink" title="3.3.1 定义"></a>3.3.1 定义</h4><p>Helper functions are a concept which enables BPF programs to consult a core kernel defifined set of function calls in order to retrieve / push data from /to the kernel. Available helper functions may differ for each BPF program type.</p>
<blockquote>
<p>不同的BPF程序类型可用的helper functions 不同。</p>
</blockquote>
<h4 id="3-3-2-样例"><a href="#3-3-2-样例" class="headerlink" title="3.3.2  样例"></a>3.3.2  样例</h4><ol>
<li>bpf_probe_read()</li>
<li>bpf_ktime_get_ns()</li>
<li>bpf_get_current_pid_tgid()</li>
<li>bpf_get_current_uid_gid()</li>
<li>bpf_get_current_comm()</li>
<li>bpf_get_current_task()</li>
<li>bpf_log2l()</li>
<li>bpf_get_prandom_u32()</li>
<li>bpf_trace_printk()</li>
<li>perf_submit()</li>
</ol>
<blockquote>
<p>有啥用呢 具体看bcc程序。</p>
</blockquote>
<hr>
<h2 id="3-4-bpf-program-type"><a href="#3-4-bpf-program-type" class="headerlink" title="3.4 bpf_program_type"></a>3.4 <strong>bpf_program_type</strong></h2><p>目前我关注的是<code>BPF_PROG_TYPE_KPROBE </code></p>
<p><code>    BPF_PROG_TYPE_TRACEPOINT</code></p>
<p>其他暂且不管。</p>
<p><a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/bpf.h#L171">https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/bpf.h#L171</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">enum bpf_prog_type &#123;</span><br><span class="line">	BPF_PROG_TYPE_UNSPEC,</span><br><span class="line">	BPF_PROG_TYPE_SOCKET_FILTER,</span><br><span class="line">	BPF_PROG_TYPE_KPROBE,</span><br><span class="line">	BPF_PROG_TYPE_SCHED_CLS,</span><br><span class="line">	BPF_PROG_TYPE_SCHED_ACT,</span><br><span class="line">	BPF_PROG_TYPE_TRACEPOINT,</span><br><span class="line">	BPF_PROG_TYPE_XDP,</span><br><span class="line">	BPF_PROG_TYPE_PERF_EVENT,</span><br><span class="line">	BPF_PROG_TYPE_CGROUP_SKB,</span><br><span class="line">	BPF_PROG_TYPE_CGROUP_SOCK,</span><br><span class="line">	BPF_PROG_TYPE_LWT_IN,</span><br><span class="line">	BPF_PROG_TYPE_LWT_OUT,</span><br><span class="line">	BPF_PROG_TYPE_LWT_XMIT,</span><br><span class="line">	BPF_PROG_TYPE_SOCK_OPS,</span><br><span class="line">	BPF_PROG_TYPE_SK_SKB,</span><br><span class="line">	BPF_PROG_TYPE_CGROUP_DEVICE,</span><br><span class="line">	BPF_PROG_TYPE_SK_MSG,</span><br><span class="line">	BPF_PROG_TYPE_RAW_TRACEPOINT,</span><br><span class="line">	BPF_PROG_TYPE_CGROUP_SOCK_ADDR,</span><br><span class="line">	BPF_PROG_TYPE_LWT_SEG6LOCAL,</span><br><span class="line">	BPF_PROG_TYPE_LIRC_MODE2,</span><br><span class="line">	BPF_PROG_TYPE_SK_REUSEPORT,</span><br><span class="line">	BPF_PROG_TYPE_FLOW_DISSECTOR,</span><br><span class="line">	BPF_PROG_TYPE_CGROUP_SYSCTL,</span><br><span class="line">	BPF_PROG_TYPE_RAW_TRACEPOINT_WRITABLE,</span><br><span class="line">	BPF_PROG_TYPE_CGROUP_SOCKOPT,</span><br><span class="line">	BPF_PROG_TYPE_TRACING,</span><br><span class="line">	BPF_PROG_TYPE_STRUCT_OPS,</span><br><span class="line">	BPF_PROG_TYPE_EXT,</span><br><span class="line">	BPF_PROG_TYPE_LSM,</span><br><span class="line">	BPF_PROG_TYPE_SK_LOOKUP,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>具体参考<a target="_blank" rel="noopener" href="https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md">https://github.com/iovisor/bcc/blob/master/docs/reference_guide.md</a></p>
<blockquote>
<p> todo:有啥用呢。具体看待会bcc程序</p>
</blockquote>
<hr>
<h2 id="3-5-BPF-Maps"><a href="#3-5-BPF-Maps" class="headerlink" title="3.5 BPF Maps"></a>3.5 BPF Maps</h2><p><img src="https://i.imgur.com/CJugUJE.png" alt="img"></p>
<blockquote>
<p>图片上直观的认知。BPF map 打通了内核态和用户态的数据传递。</p>
</blockquote>
<hr>
<h3 id="3-5-1-Maps-types"><a href="#3-5-1-Maps-types" class="headerlink" title="3.5.1 Maps types"></a>3.5.1 Maps types</h3><p>Current Generic Maps</p>
<p>● BPF_MAP_TYPE_HASH</p>
<p>● BPF_MAP_TYPE_ARRAY</p>
<p>● BPF_MAP_TYPE_PERCPU_HASH</p>
<p>● BPF_MAP_TYPE_PERCPU_ARRAY</p>
<p>● BPF_MAP_TYPE_LRU_HASH</p>
<p>● BPF_MAP_TYPE_LRU_PERCPU_HASH </p>
<p>● BPF_MAP_TYPE_LPM_TRIE</p>
<p>Current Non-Generic Maps</p>
<p>● BPF_MAP_TYPE_PROG_ARRAY</p>
<p>● BPF_MAP_TYPE_PERF_EVENT_ARRAY</p>
<p>● BPF_MAP_TYPE_CGROUP_ARRAY</p>
<p>● BPF_MAP_TYPE_STACK_TRACE</p>
<p>● BPF_MAP_TYPE_ARRAY_OF_MAPS</p>
<p>● BPF_MAP_TYPE_HASH_OF_MAPS </p>
<p>对底层key/value进行封装。</p>
<blockquote>
<p>目前我只关注前两个 BPF_MAP_TYPE_HASH  BPF_MAP_TYPE_ARRAY</p>
<p>有啥用、如何用，具体看bcc程序。</p>
</blockquote>
<hr>
<h3 id="3-5-2-BPF-MAP"><a href="#3-5-2-BPF-MAP" class="headerlink" title="3.5.2 BPF MAP"></a>3.5.2 BPF MAP</h3><p>● Kernel header</p>
<p>bpf/bpf_helpers.h</p>
<p>● User-space header</p>
<p>tools/lib/bpf/bpf.h</p>
<p>The differences</p>
<p>● in user-space use the fd to access the map, rather than using the pointer to the map directly.</p>
<p>● Bpf_map_get_next_key can only be used in user-space</p>
<blockquote>
<p>用户态用文件描述fd访问map,内核态直接用指针访问map.</p>
<p>Bpf_map_get_next_key  只能在用户态使用</p>
</blockquote>
<hr>
<h3 id="3-5-3-Loader"><a href="#3-5-3-Loader" class="headerlink" title="3.5.3 Loader"></a>3.5.3 Loader</h3><p>● bcc/bpftrace</p>
<p>● perf</p>
<p>● iproute2 (ip tc)</p>
<p>● ebpf_exporter</p>
<p>● cilium</p>
<blockquote>
<p> BPF需要加载到内核。上面是一些可用的loader。</p>
</blockquote>
<hr>
<p>接下来。我希望用 bcc 代码把上面提到的几个点都串起来。</p>
<ul>
<li>Helper Functions</li>
<li>maps</li>
<li>bpf_program_type</li>
</ul>
<h2 id="4-BCC"><a href="#4-BCC" class="headerlink" title="4.BCC"></a>4.BCC</h2><h3 id="4-1-安装-bcc-环境"><a href="#4-1-安装-bcc-环境" class="headerlink" title="4.1 安装 bcc 环境"></a>4.1 安装 bcc 环境</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ubuntu18.04</span></span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get -y install bison build-essential cmake flex git libedit-dev libllvm6.0 llvm-6.0-dev libclang-6.0-dev python zlib1g-dev libelf-dev libfl-dev</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/iovisor/bcc.git</span><br><span class="line">mkdir bcc/build; <span class="built_in">cd</span> bcc/build</span><br><span class="line">cmake ..</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">cmake -DPYTHON_CMD=python3 .. <span class="comment"># build python3 binding</span></span><br><span class="line"><span class="built_in">pushd</span> src/python/</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line"><span class="built_in">popd</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<h3 id="4-2-tools-vfsstat-py"><a href="#4-2-tools-vfsstat-py" class="headerlink" title="4.2 tools/vfsstat.py"></a>4.2 tools/vfsstat.py</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">bpf_text = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">#include &lt;uapi/linux/ptrace.h&gt;</span></span><br><span class="line"><span class="string">enum stat_types &#123;</span></span><br><span class="line"><span class="string">    S_READ = 1,</span></span><br><span class="line"><span class="string">    S_WRITE,</span></span><br><span class="line"><span class="string">    S_FSYNC,</span></span><br><span class="line"><span class="string">    S_OPEN,</span></span><br><span class="line"><span class="string">    S_CREATE,</span></span><br><span class="line"><span class="string">    S_MAXSTAT</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">BPF_ARRAY(stats, u64, S_MAXSTAT);</span></span><br><span class="line"><span class="string">static void stats_increment(int key) &#123;</span></span><br><span class="line"><span class="string">    u64 *leaf = stats.lookup(&amp;key);</span></span><br><span class="line"><span class="string">    if (leaf) (*leaf)++;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">bpf_text_kprobe = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">void do_read(struct pt_regs *ctx) &#123; stats_increment(S_READ); &#125;</span></span><br><span class="line"><span class="string">void do_write(struct pt_regs *ctx) &#123; stats_increment(S_WRITE); &#125;</span></span><br><span class="line"><span class="string">void do_fsync(struct pt_regs *ctx) &#123; stats_increment(S_FSYNC); &#125;</span></span><br><span class="line"><span class="string">void do_open(struct pt_regs *ctx) &#123; stats_increment(S_OPEN); &#125;</span></span><br><span class="line"><span class="string">void do_create(struct pt_regs *ctx) &#123; stats_increment(S_CREATE); &#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">bpf_text_kfunc = <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">KFUNC_PROBE(vfs_read, int unused)   &#123; stats_increment(S_READ); return 0; &#125;</span></span><br><span class="line"><span class="string">KFUNC_PROBE(vfs_write, int unused)  &#123; stats_increment(S_WRITE); return 0; &#125;</span></span><br><span class="line"><span class="string">KFUNC_PROBE(vfs_fsync, int unused)  &#123; stats_increment(S_FSYNC); return 0; &#125;</span></span><br><span class="line"><span class="string">KFUNC_PROBE(vfs_open, int unused)   &#123; stats_increment(S_OPEN); return 0; &#125;</span></span><br><span class="line"><span class="string">KFUNC_PROBE(vfs_create, int unused) &#123; stats_increment(S_CREATE); return 0; &#125;</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">is_support_kfunc = BPF.support_kfunc()</span><br><span class="line"><span class="comment">#is_support_kfunc = False #BPF.support_kfunc()</span></span><br><span class="line"><span class="keyword">if</span> is_support_kfunc:</span><br><span class="line">    bpf_text += bpf_text_kfunc</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    bpf_text += bpf_text_kprobe</span><br><span class="line"></span><br><span class="line">b = BPF(text=bpf_text)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> is_support_kfunc:</span><br><span class="line">    b.attach_kprobe(event=<span class="string">&quot;vfs_read&quot;</span>,   fn_name=<span class="string">&quot;do_read&quot;</span>)</span><br><span class="line">    b.attach_kprobe(event=<span class="string">&quot;vfs_write&quot;</span>,  fn_name=<span class="string">&quot;do_write&quot;</span>)</span><br><span class="line">    b.attach_kprobe(event=<span class="string">&quot;vfs_fsync&quot;</span>,  fn_name=<span class="string">&quot;do_fsync&quot;</span>)</span><br><span class="line">    b.attach_kprobe(event=<span class="string">&quot;vfs_open&quot;</span>,   fn_name=<span class="string">&quot;do_open&quot;</span>)</span><br><span class="line">    b.attach_kprobe(event=<span class="string">&quot;vfs_create&quot;</span>, fn_name=<span class="string">&quot;do_create&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># stat column labels and indexes</span></span><br><span class="line">stat_types = &#123;</span><br><span class="line">    <span class="string">&quot;READ&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;WRITE&quot;</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">&quot;FSYNC&quot;</span>: <span class="number">3</span>,</span><br><span class="line">    <span class="string">&quot;OPEN&quot;</span>: <span class="number">4</span>,</span><br><span class="line">    <span class="string">&quot;CREATE&quot;</span>: <span class="number">5</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># header</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;%-8s  &quot;</span> % <span class="string">&quot;TIME&quot;</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> stype <span class="keyword">in</span> stat_types.keys():</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; %8s&quot;</span> % (stype + <span class="string">&quot;/s&quot;</span>), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    idx = stat_types[stype]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># output</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">if</span> count &gt; <span class="number">0</span>:</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i &gt; count:</span><br><span class="line">            exit()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sleep(interval)</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%-8s: &quot;</span> % strftime(<span class="string">&quot;%H:%M:%S&quot;</span>), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="comment"># print each statistic as a column</span></span><br><span class="line">    <span class="keyword">for</span> stype <span class="keyword">in</span> stat_types.keys():</span><br><span class="line">        idx = stat_types[stype]</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            val = b[<span class="string">&quot;stats&quot;</span>][c_int(idx)].value / interval</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot; %8d&quot;</span> % val, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot; %8d&quot;</span> % <span class="number">0</span>, end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">    b[<span class="string">&quot;stats&quot;</span>].clear()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p> 最重要的代码解读 明天写</p>
</blockquote>
<h3 id="4-3-tools-biosnoop-py"><a href="#4-3-tools-biosnoop-py" class="headerlink" title="4.3 tools/biosnoop.py"></a>4.3 tools/biosnoop.py</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;uapi/linux/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/blkdev.h&gt;</span></span></span><br><span class="line"><span class="comment">// for saving the timestamp and __data_len of each request</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">start_req_t</span> &#123;</span></span><br><span class="line">    u64 ts;</span><br><span class="line">    u64 data_len;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">val_t</span> &#123;</span></span><br><span class="line">    u64 ts;</span><br><span class="line">    u32 pid;</span><br><span class="line">    <span class="keyword">char</span> name[TASK_COMM_LEN];</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> &#123;</span></span><br><span class="line">    u32 pid;</span><br><span class="line">    u64 rwflag;</span><br><span class="line">    u64 delta;</span><br><span class="line">    u64 qdelta;</span><br><span class="line">    u64 sector;</span><br><span class="line">    u64 len;</span><br><span class="line">    u64 ts;</span><br><span class="line">    <span class="keyword">char</span> disk_name[DISK_NAME_LEN];</span><br><span class="line">    <span class="keyword">char</span> name[TASK_COMM_LEN];</span><br><span class="line">&#125;;</span><br><span class="line">BPF_HASH(start, struct request *, struct <span class="keyword">start_req_t</span>);</span><br><span class="line">BPF_HASH(infobyreq, struct request *, struct <span class="keyword">val_t</span>);</span><br><span class="line">BPF_PERF_OUTPUT(events);</span><br><span class="line"><span class="comment">// cache PID and comm by-req</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">trace_pid_start</span><span class="params">(struct pt_regs *ctx, struct request *req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">val_t</span> <span class="title">val</span> =</span> &#123;&#125;;</span><br><span class="line">    u64 ts;</span><br><span class="line">    <span class="keyword">if</span> (bpf_get_current_comm(&amp;val.name, <span class="keyword">sizeof</span>(val.name)) == <span class="number">0</span>) &#123;</span><br><span class="line">        val.pid = bpf_get_current_pid_tgid() &gt;&gt; <span class="number">32</span>;</span><br><span class="line">        <span class="keyword">if</span> (##QUEUE##) &#123;</span><br><span class="line">            val.ts = bpf_ktime_get_ns();</span><br><span class="line">        &#125;</span><br><span class="line">        infobyreq.update(&amp;req, &amp;val);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// time block I/O</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">trace_req_start</span><span class="params">(struct pt_regs *ctx, struct request *req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">start_req_t</span> <span class="title">start_req</span> =</span> &#123;</span><br><span class="line">        .ts = bpf_ktime_get_ns(),</span><br><span class="line">        .data_len = req-&gt;__data_len</span><br><span class="line">    &#125;;</span><br><span class="line">    start.update(&amp;req, &amp;start_req);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">trace_req_completion</span><span class="params">(struct pt_regs *ctx, struct request *req)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">start_req_t</span> *<span class="title">startp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">val_t</span> *<span class="title">valp</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">data_t</span> <span class="title">data</span> =</span> &#123;&#125;;</span><br><span class="line">    u64 ts;</span><br><span class="line">    <span class="comment">// fetch timestamp and calculate delta</span></span><br><span class="line">    startp = start.lookup(&amp;req);</span><br><span class="line">    <span class="keyword">if</span> (startp == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// missed tracing issue</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ts = bpf_ktime_get_ns();</span><br><span class="line">    data.delta = ts - startp-&gt;ts;</span><br><span class="line">    data.ts = ts / <span class="number">1000</span>;</span><br><span class="line">    data.qdelta = <span class="number">0</span>;</span><br><span class="line">    valp = infobyreq.lookup(&amp;req);</span><br><span class="line">    data.len = startp-&gt;data_len;</span><br><span class="line">    <span class="keyword">if</span> (valp == <span class="number">0</span>) &#123;</span><br><span class="line">        data.name[<span class="number">0</span>] = <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">        data.name[<span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (##QUEUE##) &#123;</span><br><span class="line">            data.qdelta = startp-&gt;ts - valp-&gt;ts;</span><br><span class="line">        &#125;</span><br><span class="line">        data.pid = valp-&gt;pid;</span><br><span class="line">        data.sector = req-&gt;__sector;</span><br><span class="line">        bpf_probe_read_kernel(&amp;data.name, <span class="keyword">sizeof</span>(data.name), valp-&gt;name);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">gendisk</span> *<span class="title">rq_disk</span> =</span> req-&gt;rq_disk;</span><br><span class="line">        bpf_probe_read_kernel(&amp;data.disk_name, <span class="keyword">sizeof</span>(data.disk_name),</span><br><span class="line">                       rq_disk-&gt;disk_name);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The following deals with a kernel version change (in mainline 4.7, although</span></span><br><span class="line"><span class="comment"> * it may be backported to earlier kernels) with how block request write flags</span></span><br><span class="line"><span class="comment"> * are tested. We handle both pre- and post-change versions here. Please avoid</span></span><br><span class="line"><span class="comment"> * kernel version tests like this as much as possible: they inflate the code,</span></span><br><span class="line"><span class="comment"> * test, and maintenance burden.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> REQ_WRITE</span></span><br><span class="line">    data.rwflag = !!(req-&gt;cmd_flags &amp; REQ_WRITE);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined(REQ_OP_SHIFT)</span></span><br><span class="line">    data.rwflag = !!((req-&gt;cmd_flags &gt;&gt; REQ_OP_SHIFT) == REQ_OP_WRITE);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    data.rwflag = !!((req-&gt;cmd_flags &amp; REQ_OP_MASK) == REQ_OP_WRITE);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    events.perf_submit(ctx, &amp;data, <span class="keyword">sizeof</span>(data));</span><br><span class="line">    start.<span class="keyword">delete</span>(&amp;req);</span><br><span class="line">    infobyreq.<span class="keyword">delete</span>(&amp;req);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>最重要的代码解读明天写</p>
</blockquote>
<hr>
<h3 id="4-4-如果没有bcc呢"><a href="#4-4-如果没有bcc呢" class="headerlink" title="4.4 如果没有bcc呢?"></a>4.4 如果没有bcc呢?</h3><p>参考一位师兄的博客。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_34258344/article/details/108932912">Ubuntu下bpf纯c程序的编写与运行</a></p>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>Author: </span>
      <a href="http://example.com">zstone12</a>
    </p>
    <p class="copyright-item">
      <span>Link: </span>
      <a href="http://example.com/2021/04/12/BPF%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/">http://example.com/2021/04/12/BPF%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8/</a>
    </p>
    <p class="copyright-item">
      <span>License: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        
        <nav class="post-nav"><a class="prev" href="/2021/11/26/%E9%97%AE%E9%A2%98%E5%A4%8D%E7%9B%98/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">问题复盘</span>
        <span class="prev-text nav-mobile">Prev</span>
      </a>
    <a class="next" href="/2021/04/08/bcc-mysql%E7%9B%B8%E5%85%B3%E8%B8%A9%E5%9D%91%E8%BF%87%E7%A8%8B/">
        <span class="next-text nav-default">bcc/MySQL相关踩坑过程</span>
        <span class="prev-text nav-mobile">Next</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"></div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:your@email.com" class="iconfont icon-email" title="email"></a>
        <a target="_blank" rel="noopener" href="https://github.com/ahonn" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" target="_blank" rel="noopener" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2023<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">zstone12</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.2"></script>
</body>
</html>
